services:
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 12

  users-db:
    image: postgres:16
    environment:
      POSTGRES_DB: users
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    volumes:
      - users-db-data:/var/lib/postgresql/data

  wallet-db:
    image: postgres:16
    environment:
      POSTGRES_DB: wallet
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"
    volumes:
      - wallet-db-data:/var/lib/postgresql/data

  users:
    build:
      context: .
      dockerfile: services/users/Dockerfile
    environment:
      USERS_PORT: "${USERS_PORT:-3002}"
      JWT_PRIVATE_KEY: "${JWT_PRIVATE_KEY:-ILIACHALLENGE}"
      USERS_DATABASE_URL: "${USERS_DATABASE_URL:-postgres://postgres:postgres@users-db:5432/users}"
      RABBITMQ_URL: "${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672}"
    ports:
      - "3002:3002"
    depends_on:
      users-migrate:
        condition: service_completed_successfully
      users-db:
        condition: service_started
      rabbitmq:
        condition: service_healthy

  wallet:
    build:
      context: .
      dockerfile: services/wallet/Dockerfile
    environment:
      WALLET_PORT: "${WALLET_PORT:-3001}"
      JWT_PRIVATE_KEY: "${JWT_PRIVATE_KEY:-ILIACHALLENGE}"
      WALLET_DATABASE_URL: "${WALLET_DATABASE_URL:-postgres://postgres:postgres@wallet-db:5432/wallet}"
      RABBITMQ_URL: "${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672}"
    ports:
      - "3001:3001"
    depends_on:
      wallet-migrate:
        condition: service_completed_successfully
      wallet-db:
        condition: service_started
      rabbitmq:
        condition: service_healthy

  users-worker:
    build:
      context: .
      dockerfile: services/users/Dockerfile
    command: ["bun", "src/worker.ts"]
    environment:
      USERS_PORT: "${USERS_PORT:-3002}"
      JWT_PRIVATE_KEY: "${JWT_PRIVATE_KEY:-ILIACHALLENGE}"
      USERS_DATABASE_URL: "${USERS_DATABASE_URL:-postgres://postgres:postgres@users-db:5432/users}"
      RABBITMQ_URL: "${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672}"
      RABBITMQ_CONNECT_RETRIES: "${RABBITMQ_CONNECT_RETRIES:-30}"
      RABBITMQ_CONNECT_DELAY_MS: "${RABBITMQ_CONNECT_DELAY_MS:-1000}"
    depends_on:
      users-migrate:
        condition: service_completed_successfully
      users-db:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  wallet-worker:
    build:
      context: .
      dockerfile: services/wallet/Dockerfile
    command: ["bun", "src/worker.ts"]
    environment:
      WALLET_PORT: "${WALLET_PORT:-3001}"
      JWT_PRIVATE_KEY: "${JWT_PRIVATE_KEY:-ILIACHALLENGE}"
      WALLET_DATABASE_URL: "${WALLET_DATABASE_URL:-postgres://postgres:postgres@wallet-db:5432/wallet}"
      RABBITMQ_URL: "${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672}"
      RABBITMQ_CONNECT_RETRIES: "${RABBITMQ_CONNECT_RETRIES:-30}"
      RABBITMQ_CONNECT_DELAY_MS: "${RABBITMQ_CONNECT_DELAY_MS:-1000}"
    depends_on:
      wallet-migrate:
        condition: service_completed_successfully
      wallet-db:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  users-migrate:
    build:
      context: .
      dockerfile: services/users/Dockerfile
    command:
      [
        "sh",
        "-c",
        "until pg_isready -d \"$USERS_DATABASE_URL\"; do sleep 1; done; sh ./src/migrate.sh",
      ]
    environment:
      USERS_DATABASE_URL: "${USERS_DATABASE_URL:-postgres://postgres:postgres@users-db:5432/users}"
    depends_on:
      - users-db
    restart: "no"

  wallet-migrate:
    build:
      context: .
      dockerfile: services/wallet/Dockerfile
    command:
      [
        "sh",
        "-c",
        "until pg_isready -d \"$WALLET_DATABASE_URL\"; do sleep 1; done; sh ./src/migrate.sh",
      ]
    environment:
      WALLET_DATABASE_URL: "${WALLET_DATABASE_URL:-postgres://postgres:postgres@wallet-db:5432/wallet}"
    depends_on:
      - wallet-db
    restart: "no"

  docs:
    image: swaggerapi/swagger-ui:v5.17.14
    environment:
      - URLS=[{"name":"users","url":"http://localhost:3002/openapi.json"},{"name":"wallet","url":"http://localhost:3001/openapi.json"}]
    ports:
      - "8080:8080"
    depends_on:
      users:
        condition: service_started
      wallet:
        condition: service_started

volumes:
  users-db-data:
  wallet-db-data:
